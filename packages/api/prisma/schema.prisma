// Lattice Service Discovery Database Schema
// Version: 1.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Service entity - Deployed applications and microservices
model Service {
  id               String   @id @default(cuid())
  name             String   @unique
  version          String?
  environment      String?
  deploymentType   String?
  language         String
  framework        String
  runtime          String?
  description      String?
  repository       String?
  healthCheckUrl   String?
  status           String   @default("unknown") // active, inactive, unknown
  firstSeen        DateTime @default(now())
  lastSeen         DateTime @updatedAt

  // Plugin info (stored as JSON)
  discoveredBy     Json
  metadata         Json?

  // Relationships
  routes           Route[]
  dependencies     Dependency[]
  outgoingConnections Connection[] @relation("SourceService")
  incomingConnections Connection[] @relation("TargetService")

  @@index([name])
  @@index([status])
  @@index([lastSeen])
}

// Route entity - HTTP endpoints within services
model Route {
  id                String   @id @default(cuid())
  serviceId         String
  method            String
  path              String
  middlewareChain   String[] // Array of middleware names
  handlerLocation   Json?
  pathParameters    Json?
  queryParameters   Json?
  requestSchema     Json?
  responseSchema    Json?
  description       String?
  tags              String[]
  avgResponseTimeMs Float?
  callFrequency     Float?
  errorRate         Float?
  firstSeen         DateTime @default(now())
  lastSeen          DateTime @updatedAt
  metadata          Json?

  service           Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  connections       Connection[] @relation("TargetRoute")

  @@unique([serviceId, method, path])
  @@index([serviceId])
  @@index([method])
}

// Dependency entity - External packages used by services
model Dependency {
  id                  String   @id @default(cuid())
  serviceId           String
  packageName         String
  version             String
  versionRange        String?
  dependencyType      String   // direct, transitive, peer, dev
  scope               String?
  installedSize       Int?
  publishSize         Int?
  fileCount           Int?
  hasVulnerabilities  Boolean?
  vulnerabilityCount  Int?
  highestSeverity     String?
  description         String?
  license             String?
  repository          String?
  homepage            String?
  firstSeen           DateTime @default(now())
  lastSeen            DateTime @updatedAt
  metadata            Json?

  service             Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, packageName])
  @@index([serviceId])
  @@index([packageName])
  @@index([hasVulnerabilities])
}

// Connection entity - Service-to-service communication edges
model Connection {
  id                  String   @id @default(cuid())
  sourceServiceId     String
  targetServiceId     String
  targetRouteId       String?
  method              String
  path                String
  callCount           Int      @default(0)
  avgResponseTimeMs   Float?
  p95ResponseTimeMs   Float?
  p99ResponseTimeMs   Float?
  successCount        Int      @default(0)
  errorCount          Int      @default(0)
  errorRate           Float    @default(0)
  requestFrequency    Float?
  peakTime            String?
  firstSeen           DateTime @default(now())
  lastSeen            DateTime @updatedAt
  sampleTraceIds      String[]
  metadata            Json?

  sourceService       Service  @relation("SourceService", fields: [sourceServiceId], references: [id], onDelete: Cascade)
  targetService       Service  @relation("TargetService", fields: [targetServiceId], references: [id], onDelete: Cascade)
  targetRoute         Route?   @relation("TargetRoute", fields: [targetRouteId], references: [id], onDelete: SetNull)

  @@unique([sourceServiceId, targetServiceId, method, path])
  @@index([sourceServiceId])
  @@index([targetServiceId])
  @@index([sourceServiceId, targetServiceId])
  @@index([lastSeen])
}

// Plugin registry - Framework-specific analyzers
model Plugin {
  id                      String   @id @default(cuid())
  name                    String   @unique
  version                 String
  supportedFrameworks     String[]
  supportedSchemaVersions String[]
  preferredSchemaVersion  String
  canDiscoverRoutes       Boolean  @default(false)
  canDiscoverDependencies Boolean  @default(false)
  canTrackConnections     Boolean  @default(false)
  description             String?
  author                  String?
  repository              String?
  documentation           String?
  servicesUsing           Int      @default(0)
  registeredAt            DateTime @default(now())
  lastUsed                DateTime?
  metadata                Json?

  @@index([name])
}
