{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,IAAI,EAAE,MAAM,MAAM,CAAC;AAC5B,OAAO,IAAI,MAAM,WAAW,CAAC;AAC7B,OAAO,EAAE,MAAM,SAAS,CAAC;AACzB,OAAO,EAGL,aAAa,EAGb,UAAU,EACV,cAAc,EACd,UAAU,GACX,MAAM,qBAAqB,CAAC;AAe7B,oCAAoC;AACpC,OAAO,EACL,qBAAqB,EACrB,YAAY,EACZ,aAAa,EACb,cAAc,EACd,gBAAgB,GACjB,MAAM,sBAAsB,CAAC;AAC9B,OAAO,EAAE,OAAO,IAAI,WAAW,EAAE,MAAM,+BAA+B,CAAC;AACvE,OAAO,EAAE,OAAO,IAAI,KAAK,EAAE,MAAM,wBAAwB,CAAC;AAE1D,MAAM,OAAO,iBAAiB;IAG5B,YAAY,MAAyB;QACnC,IAAI,CAAC,MAAM,GAAG;YACZ,WAAW,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ,IAAI,aAAa;YAClD,WAAW,EAAE,OAAO,CAAC,GAAG,CAAC,oBAAoB,IAAI,8BAA8B;YAC/E,MAAM,EAAE,MAAM,CAAC,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,eAAe,IAAI,EAAE;YAC1D,OAAO,EAAE,MAAM,CAAC,OAAO,IAAI,IAAI;YAC/B,UAAU,EAAE,MAAM,CAAC,UAAU,IAAI,IAAI;YACrC,MAAM,EAAE,MAAM,CAAC,MAAM,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC;YAC5D,UAAU,EAAE,MAAM,CAAC,UAAU,IAAI,CAAC,GAAG,EAAE,GAAE,CAAC,CAAC;YAC3C,WAAW,EAAE,MAAM,CAAC,WAAW,IAAI,CAAC,GAAG,EAAE,GAAE,CAAC,CAAC;YAC7C,OAAO,EAAE,MAAM,CAAC,OAAO,IAAI,CAAC,GAAG,EAAE,GAAE,CAAC,CAAC;YACrC,GAAG,MAAM;SACV,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,OAAO;QACX,IAAI,CAAC;YACH,MAAM,SAAS,GAAG,UAAU,EAAE,CAAC;YAC/B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC;YACpD,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,CAAC;YAEhE,MAAM,OAAO,GAAY;gBACvB,EAAE,EAAE,SAAS;gBACb,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,WAAW;gBAC7B,OAAO,EAAE,IAAI,CAAC,iBAAiB,EAAE;gBACjC,WAAW,EAAE,IAAI,CAAC,MAAM,CAAC,WAAW;gBACpC,QAAQ,EAAE,YAAY;gBACtB,SAAS,EAAE,QAAQ;gBACnB,OAAO,EAAE,QAAQ,OAAO,CAAC,OAAO,EAAE;gBAClC,MAAM,EAAE,aAAa,CAAC,MAAM;gBAC5B,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;gBACpB,YAAY,EAAE;oBACZ,UAAU,EAAE,wBAAwB;oBACpC,aAAa,EAAE,OAAO;oBACtB,aAAa,EAAE,OAAO;iBACvB;aACF,CAAC;YAEF,MAAM,QAAQ,GAA8B;gBAC1C,OAAO;gBACP,MAAM;gBACN,YAAY;aACb,CAAC;YAEF,OAAO,CAAC,GAAG,CAAC,iCAAiC,IAAI,CAAC,MAAM,CAAC,WAAW,UAAU,MAAM,CAAC,MAAM,eAAe,YAAY,CAAC,MAAM,eAAe,CAAC,CAAC;YAE9I,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YAEjC,IAAI,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC;gBAC3B,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YAC9B,CAAC;YAED,OAAO,QAAQ,CAAC;QAClB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,GAAG,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;YACtE,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACzB,MAAM,GAAG,CAAC;QACZ,CAAC;IACH,CAAC;IAEO,KAAK,CAAC,cAAc,CAAC,SAAiB;QAC5C,MAAM,MAAM,GAAY,EAAE,CAAC;QAE3B,wDAAwD;QACxD,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;QAClC,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAExC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC;YAC3B,OAAO,CAAC,GAAG,CAAC,iCAAiC,MAAM,EAAE,CAAC,CAAC;YACvD,OAAO,MAAM,CAAC;QAChB,CAAC;QAED,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,kBAAkB,EAAE;YAChD,GAAG,EAAE,MAAM;YACX,QAAQ,EAAE,IAAI;SACf,CAAC,CAAC;QAEH,KAAK,MAAM,IAAI,IAAI,UAAU,EAAE,CAAC;YAC9B,MAAM,OAAO,GAAG,EAAE,CAAC,YAAY,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;YAC/C,MAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;YACjD,MAAM,SAAS,GAAG,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;YAEvE,qCAAqC;YACrC,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC;YAEjD,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;gBAC7B,MAAM,CAAC,IAAI,CAAC;oBACV,EAAE,EAAE,UAAU,EAAE;oBAChB,SAAS;oBACT,MAAM;oBACN,IAAI,EAAE,SAAS,KAAK,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,SAAS,EAAE;oBACrD,eAAe,EAAE,CAAC,mBAAmB,CAAC;oBACtC,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;iBACrB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;IAEO,kBAAkB,CAAC,OAAe;QACxC,MAAM,OAAO,GAAiB,EAAE,CAAC;QACjC,MAAM,WAAW,GAAiB;YAChC,UAAU,CAAC,GAAG;YACd,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,GAAG;YACd,UAAU,CAAC,MAAM;YACjB,UAAU,CAAC,KAAK;YAChB,UAAU,CAAC,OAAO;YAClB,UAAU,CAAC,IAAI;SAChB,CAAC;QAEF,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;YACjC,gEAAgE;YAChE,IAAI,IAAI,MAAM,CAAC,qCAAqC,MAAM,EAAE,EAAE,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;gBACjF,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACvB,CAAC;QACH,CAAC;QAED,OAAO,OAAO,CAAC;IACjB,CAAC;IAEO,KAAK,CAAC,oBAAoB,CAAC,SAAiB;QAClD,MAAM,YAAY,GAAiB,EAAE,CAAC;QACtC,MAAM,eAAe,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,cAAc,CAAC,CAAC;QAEjE,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,eAAe,CAAC,EAAE,CAAC;YACpC,OAAO,YAAY,CAAC;QACtB,CAAC;QAED,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,eAAe,EAAE,OAAO,CAAC,CAAC,CAAC;QAC1E,MAAM,IAAI,GAAG,WAAW,CAAC,YAAY,IAAI,EAAE,CAAC;QAC5C,MAAM,OAAO,GAAG,WAAW,CAAC,eAAe,IAAI,EAAE,CAAC;QAElD,8BAA8B;QAC9B,KAAK,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;YACnD,YAAY,CAAC,IAAI,CAAC;gBAChB,EAAE,EAAE,UAAU,EAAE;gBAChB,SAAS;gBACT,WAAW,EAAE,IAAI;gBACjB,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC;gBAC9C,YAAY,EAAE,MAAM,CAAC,OAAO,CAAC;gBAC7B,cAAc,EAAE,cAAc,CAAC,MAAM;gBACrC,KAAK,EAAE,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS;gBAC5D,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;aACrB,CAAC,CAAC;QACL,CAAC;QAED,uBAAuB;QACvB,KAAK,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC;YACtD,YAAY,CAAC,IAAI,CAAC;gBAChB,EAAE,EAAE,UAAU,EAAE;gBAChB,SAAS;gBACT,WAAW,EAAE,IAAI;gBACjB,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC;gBAC9C,YAAY,EAAE,MAAM,CAAC,OAAO,CAAC;gBAC7B,cAAc,EAAE,cAAc,CAAC,GAAG;gBAClC,KAAK,EAAE,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS;gBAC5D,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,QAAQ,EAAE,IAAI,IAAI,EAAE;aACrB,CAAC,CAAC;QACL,CAAC;QAED,OAAO,YAAY,CAAC;IACtB,CAAC;IAEO,iBAAiB;QACvB,MAAM,eAAe,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,cAAc,CAAC,CAAC;QACjE,IAAI,EAAE,CAAC,UAAU,CAAC,eAAe,CAAC,EAAE,CAAC;YACnC,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,eAAe,EAAE,OAAO,CAAC,CAAC,CAAC;YAC1E,OAAO,WAAW,CAAC,OAAO,IAAI,OAAO,CAAC;QACxC,CAAC;QACD,OAAO,OAAO,CAAC;IACjB,CAAC;IAEO,KAAK,CAAC,MAAM,CAAC,QAAmC;QACtD,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO;YAAE,OAAO;QAEjC,IAAI,CAAC;YACH,MAAM,OAAO,GAA2B;gBACtC,cAAc,EAAE,kBAAkB;aACnC,CAAC;YAEF,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC;gBACvB,OAAO,CAAC,mBAAmB,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;YACpD,CAAC;YAED,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,kBAAkB,EAAE;gBACzE,MAAM,EAAE,MAAM;gBACd,OAAO;gBACP,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC;aAC/B,CAAC,CAAC;YAEH,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;gBACjB,MAAM,IAAI,KAAK,CAAC,qBAAqB,QAAQ,CAAC,UAAU,EAAE,CAAC,CAAC;YAC9D,CAAC;YAED,MAAM,MAAM,GAAG,CAAC,MAAM,QAAQ,CAAC,IAAI,EAAE,CAA0B,CAAC;YAChE,OAAO,CAAC,GAAG,CAAC,iCAAiC,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC;YACjE,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;QAClC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,GAAG,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;YACtE,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAC3B,CAAC;IACH,CAAC;CACF","sourcesContent":["import { glob } from 'glob';\nimport path from 'node:path';\nimport fs from 'node:fs';\nimport {\n  Service,\n  ServiceMetadataSubmission,\n  ServiceStatus,\n  Route,\n  Dependency,\n  HttpMethod,\n  DependencyType,\n  generateId,\n} from '@lattice.black/core';\n\nexport interface LatticeNextConfig {\n  serviceName: string;\n  environment?: string;\n  apiEndpoint?: string;\n  apiKey?: string;\n  enabled?: boolean;\n  autoSubmit?: boolean;\n  appDir?: string; // Path to Next.js app directory\n  onAnalyzed?: (metadata: ServiceMetadataSubmission) => void;\n  onSubmitted?: (response: any) => void;\n  onError?: (error: Error) => void;\n}\n\n// Re-export error capture utilities\nexport {\n  initLatticeMonitoring,\n  captureError,\n  addBreadcrumb,\n  getBreadcrumbs,\n  clearBreadcrumbs,\n} from './client/browser-sdk';\nexport { default as GlobalError } from './error-boundary/global-error';\nexport { default as Error } from './error-boundary/error';\n\nexport class LatticeNextPlugin {\n  private config: Required<LatticeNextConfig>;\n\n  constructor(config: LatticeNextConfig) {\n    this.config = {\n      environment: process.env.NODE_ENV || 'development',\n      apiEndpoint: process.env.LATTICE_API_ENDPOINT || 'http://localhost:3000/api/v1',\n      apiKey: config.apiKey || process.env.LATTICE_API_KEY || '',\n      enabled: config.enabled ?? true,\n      autoSubmit: config.autoSubmit ?? true,\n      appDir: config.appDir || path.join(process.cwd(), 'src/app'),\n      onAnalyzed: config.onAnalyzed || (() => {}),\n      onSubmitted: config.onSubmitted || (() => {}),\n      onError: config.onError || (() => {}),\n      ...config,\n    };\n  }\n\n  async analyze(): Promise<ServiceMetadataSubmission> {\n    try {\n      const serviceId = generateId();\n      const routes = await this.discoverRoutes(serviceId);\n      const dependencies = await this.discoverDependencies(serviceId);\n\n      const service: Service = {\n        id: serviceId,\n        name: this.config.serviceName,\n        version: this.getPackageVersion(),\n        environment: this.config.environment,\n        language: 'typescript',\n        framework: 'nextjs',\n        runtime: `node-${process.version}`,\n        status: ServiceStatus.Active,\n        firstSeen: new Date(),\n        lastSeen: new Date(),\n        discoveredBy: {\n          pluginName: '@lattice/plugin-nextjs',\n          pluginVersion: '0.1.0',\n          schemaVersion: '1.0.0',\n        },\n      };\n\n      const metadata: ServiceMetadataSubmission = {\n        service,\n        routes,\n        dependencies,\n      };\n\n      console.log(`✅ Lattice discovered service \"${this.config.serviceName}\" with ${routes.length} routes and ${dependencies.length} dependencies`);\n\n      this.config.onAnalyzed(metadata);\n\n      if (this.config.autoSubmit) {\n        await this.submit(metadata);\n      }\n\n      return metadata;\n    } catch (error) {\n      const err = error instanceof Error ? error : new Error(String(error));\n      this.config.onError(err);\n      throw err;\n    }\n  }\n\n  private async discoverRoutes(serviceId: string): Promise<Route[]> {\n    const routes: Route[] = [];\n\n    // Find all route.ts/route.js files in app/api directory\n    const appDir = this.config.appDir;\n    const apiDir = path.join(appDir, 'api');\n\n    if (!fs.existsSync(apiDir)) {\n      console.log(`ℹ️  No API directory found at ${apiDir}`);\n      return routes;\n    }\n\n    const routeFiles = await glob('**/route.{ts,js}', {\n      cwd: apiDir,\n      absolute: true,\n    });\n\n    for (const file of routeFiles) {\n      const content = fs.readFileSync(file, 'utf-8');\n      const relativePath = path.relative(apiDir, file);\n      const routePath = '/' + path.dirname(relativePath).replace(/\\\\/g, '/');\n\n      // Extract HTTP methods from the file\n      const methods = this.extractHTTPMethods(content);\n\n      for (const method of methods) {\n        routes.push({\n          id: generateId(),\n          serviceId,\n          method,\n          path: routePath === '/' ? '/api' : `/api${routePath}`,\n          middlewareChain: ['nextjs-app-router'],\n          firstSeen: new Date(),\n          lastSeen: new Date(),\n        });\n      }\n    }\n\n    return routes;\n  }\n\n  private extractHTTPMethods(content: string): HttpMethod[] {\n    const methods: HttpMethod[] = [];\n    const httpMethods: HttpMethod[] = [\n      HttpMethod.GET,\n      HttpMethod.POST,\n      HttpMethod.PUT,\n      HttpMethod.DELETE,\n      HttpMethod.PATCH,\n      HttpMethod.OPTIONS,\n      HttpMethod.HEAD,\n    ];\n\n    for (const method of httpMethods) {\n      // Look for \"export async function GET\" or \"export function GET\"\n      if (new RegExp(`export\\\\s+(async\\\\s+)?function\\\\s+${method}`, 'g').test(content)) {\n        methods.push(method);\n      }\n    }\n\n    return methods;\n  }\n\n  private async discoverDependencies(serviceId: string): Promise<Dependency[]> {\n    const dependencies: Dependency[] = [];\n    const packageJsonPath = path.join(process.cwd(), 'package.json');\n\n    if (!fs.existsSync(packageJsonPath)) {\n      return dependencies;\n    }\n\n    const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n    const deps = packageJson.dependencies || {};\n    const devDeps = packageJson.devDependencies || {};\n\n    // Add production dependencies\n    for (const [name, version] of Object.entries(deps)) {\n      dependencies.push({\n        id: generateId(),\n        serviceId,\n        packageName: name,\n        version: String(version).replace(/^[\\^~]/, ''),\n        versionRange: String(version),\n        dependencyType: DependencyType.Direct,\n        scope: name.startsWith('@') ? name.split('/')[0] : undefined,\n        firstSeen: new Date(),\n        lastSeen: new Date(),\n      });\n    }\n\n    // Add dev dependencies\n    for (const [name, version] of Object.entries(devDeps)) {\n      dependencies.push({\n        id: generateId(),\n        serviceId,\n        packageName: name,\n        version: String(version).replace(/^[\\^~]/, ''),\n        versionRange: String(version),\n        dependencyType: DependencyType.Dev,\n        scope: name.startsWith('@') ? name.split('/')[0] : undefined,\n        firstSeen: new Date(),\n        lastSeen: new Date(),\n      });\n    }\n\n    return dependencies;\n  }\n\n  private getPackageVersion(): string {\n    const packageJsonPath = path.join(process.cwd(), 'package.json');\n    if (fs.existsSync(packageJsonPath)) {\n      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n      return packageJson.version || '1.0.0';\n    }\n    return '1.0.0';\n  }\n\n  private async submit(metadata: ServiceMetadataSubmission): Promise<void> {\n    if (!this.config.enabled) return;\n\n    try {\n      const headers: Record<string, string> = {\n        'Content-Type': 'application/json',\n      };\n\n      if (this.config.apiKey) {\n        headers['X-Lattice-API-Key'] = this.config.apiKey;\n      }\n\n      const response = await fetch(`${this.config.apiEndpoint}/ingest/metadata`, {\n        method: 'POST',\n        headers,\n        body: JSON.stringify(metadata),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Failed to submit: ${response.statusText}`);\n      }\n\n      const result = (await response.json()) as { serviceId: string };\n      console.log(`✅ Lattice metadata submitted: ${result.serviceId}`);\n      this.config.onSubmitted(result);\n    } catch (error) {\n      const err = error instanceof Error ? error : new Error(String(error));\n      this.config.onError(err);\n    }\n  }\n}\n"]}