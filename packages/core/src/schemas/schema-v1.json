{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lattice.dev/schemas/service-metadata/v1.0.0",
  "version": "1.0.0",
  "title": "Lattice Service Metadata Schema",
  "description": "Unified schema for service discovery metadata across all languages and frameworks",

  "definitions": {
    "Service": {
      "type": "object",
      "required": ["id", "name", "language", "framework", "status", "discoveredBy"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique service identifier",
          "pattern": "^[a-z0-9]+$"
        },
        "name": {
          "type": "string",
          "description": "Service name (DNS-compatible)",
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
          "minLength": 2,
          "maxLength": 63
        },
        "version": {
          "type": "string",
          "description": "Semantic version",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$"
        },
        "environment": {
          "type": "string",
          "enum": ["development", "staging", "production"],
          "description": "Deployment environment"
        },
        "deploymentType": {
          "type": "string",
          "enum": ["kubernetes", "docker", "serverless", "bare-metal"],
          "description": "Deployment platform"
        },
        "language": {
          "type": "string",
          "description": "Programming language",
          "examples": ["javascript", "typescript", "python", "go"]
        },
        "framework": {
          "type": "string",
          "description": "Framework or library",
          "examples": ["express", "fastapi", "django", "spring-boot"]
        },
        "runtime": {
          "type": "string",
          "description": "Runtime version",
          "examples": ["node-18", "python-3.11", "go-1.21"]
        },
        "description": {
          "type": "string",
          "description": "Human-readable service description"
        },
        "repository": {
          "type": "string",
          "format": "uri",
          "description": "Git repository URL"
        },
        "healthCheckUrl": {
          "type": "string",
          "format": "uri-reference",
          "description": "Health check endpoint path"
        },
        "status": {
          "type": "string",
          "enum": ["active", "inactive", "unknown"],
          "description": "Service operational status"
        },
        "firstSeen": {
          "type": "string",
          "format": "date-time",
          "description": "When service was first discovered"
        },
        "lastSeen": {
          "type": "string",
          "format": "date-time",
          "description": "Last heartbeat timestamp"
        },
        "discoveredBy": {
          "type": "object",
          "required": ["pluginName", "pluginVersion", "schemaVersion"],
          "properties": {
            "pluginName": {
              "type": "string",
              "description": "Plugin package name"
            },
            "pluginVersion": {
              "type": "string",
              "description": "Plugin version"
            },
            "schemaVersion": {
              "type": "string",
              "description": "Schema version used"
            }
          }
        },
        "metadata": {
          "type": "object",
          "description": "Plugin-specific extensibility"
        }
      }
    },

    "Route": {
      "type": "object",
      "required": ["id", "serviceId", "method", "path"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique route identifier"
        },
        "serviceId": {
          "type": "string",
          "description": "Parent service ID"
        },
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS", "ALL"],
          "description": "HTTP method"
        },
        "path": {
          "type": "string",
          "pattern": "^\\/",
          "description": "URL path pattern",
          "examples": ["/users", "/users/:id", "/files/*"]
        },
        "middlewareChain": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Ordered middleware names"
        },
        "handlerLocation": {
          "type": "object",
          "properties": {
            "file": {
              "type": "string",
              "description": "Source file path"
            },
            "line": {
              "type": "integer",
              "minimum": 1,
              "description": "Line number"
            },
            "function": {
              "type": "string",
              "description": "Handler function name"
            }
          }
        },
        "pathParameters": {
          "type": "array",
          "items": { "$ref": "#/definitions/RouteParameter" }
        },
        "queryParameters": {
          "type": "array",
          "items": { "$ref": "#/definitions/RouteParameter" }
        },
        "requestSchema": {
          "type": "object",
          "description": "JSON Schema for request body"
        },
        "responseSchema": {
          "type": "object",
          "description": "JSON Schema for response body"
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "avgResponseTimeMs": {
          "type": "number",
          "minimum": 0
        },
        "callFrequency": {
          "type": "number",
          "minimum": 0
        },
        "errorRate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "firstSeen": {
          "type": "string",
          "format": "date-time"
        },
        "lastSeen": {
          "type": "string",
          "format": "date-time"
        },
        "metadata": {
          "type": "object"
        }
      }
    },

    "RouteParameter": {
      "type": "object",
      "required": ["name", "required"],
      "properties": {
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "object", "array"]
        },
        "required": {
          "type": "boolean"
        },
        "description": {
          "type": "string"
        },
        "example": {}
      }
    },

    "Dependency": {
      "type": "object",
      "required": ["id", "serviceId", "packageName", "version", "dependencyType"],
      "properties": {
        "id": {
          "type": "string"
        },
        "serviceId": {
          "type": "string"
        },
        "packageName": {
          "type": "string",
          "description": "Package name (npm/pip/gem)"
        },
        "version": {
          "type": "string",
          "description": "Installed version"
        },
        "versionRange": {
          "type": "string",
          "description": "Declared version range"
        },
        "dependencyType": {
          "type": "string",
          "enum": ["direct", "transitive", "peer", "dev"],
          "description": "Dependency classification"
        },
        "scope": {
          "type": "string",
          "description": "npm scope (@lattice)"
        },
        "installedSize": {
          "type": "integer",
          "minimum": 0,
          "description": "Bytes on disk"
        },
        "publishSize": {
          "type": "integer",
          "minimum": 0,
          "description": "Tarball size"
        },
        "fileCount": {
          "type": "integer",
          "minimum": 0
        },
        "hasVulnerabilities": {
          "type": "boolean"
        },
        "vulnerabilityCount": {
          "type": "integer",
          "minimum": 0
        },
        "highestSeverity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"]
        },
        "description": {
          "type": "string"
        },
        "license": {
          "type": "string"
        },
        "repository": {
          "type": "string",
          "format": "uri"
        },
        "homepage": {
          "type": "string",
          "format": "uri"
        },
        "firstSeen": {
          "type": "string",
          "format": "date-time"
        },
        "lastSeen": {
          "type": "string",
          "format": "date-time"
        },
        "metadata": {
          "type": "object"
        }
      }
    },

    "Connection": {
      "type": "object",
      "required": ["id", "sourceServiceId", "targetServiceId", "method", "path", "callCount", "successCount", "errorCount", "errorRate"],
      "properties": {
        "id": {
          "type": "string"
        },
        "sourceServiceId": {
          "type": "string",
          "description": "Service making the call"
        },
        "targetServiceId": {
          "type": "string",
          "description": "Service being called"
        },
        "targetRouteId": {
          "type": "string",
          "description": "Specific route (optional)"
        },
        "method": {
          "type": "string"
        },
        "path": {
          "type": "string"
        },
        "callCount": {
          "type": "integer",
          "minimum": 0
        },
        "avgResponseTimeMs": {
          "type": "number",
          "minimum": 0
        },
        "p95ResponseTimeMs": {
          "type": "number",
          "minimum": 0
        },
        "p99ResponseTimeMs": {
          "type": "number",
          "minimum": 0
        },
        "successCount": {
          "type": "integer",
          "minimum": 0
        },
        "errorCount": {
          "type": "integer",
          "minimum": 0
        },
        "errorRate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "requestFrequency": {
          "type": "number",
          "minimum": 0
        },
        "peakTime": {
          "type": "string",
          "description": "ISO hour string"
        },
        "firstSeen": {
          "type": "string",
          "format": "date-time"
        },
        "lastSeen": {
          "type": "string",
          "format": "date-time"
        },
        "sampleTraceIds": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "metadata": {
          "type": "object"
        }
      }
    },

    "Plugin": {
      "type": "object",
      "required": ["id", "name", "version", "supportedSchemaVersions", "preferredSchemaVersion"],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string",
          "description": "npm package name"
        },
        "version": {
          "type": "string",
          "description": "Plugin version"
        },
        "supportedFrameworks": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "supportedSchemaVersions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "preferredSchemaVersion": {
          "type": "string"
        },
        "canDiscoverRoutes": {
          "type": "boolean"
        },
        "canDiscoverDependencies": {
          "type": "boolean"
        },
        "canTrackConnections": {
          "type": "boolean"
        },
        "description": {
          "type": "string"
        },
        "author": {
          "type": "string"
        },
        "repository": {
          "type": "string",
          "format": "uri"
        },
        "documentation": {
          "type": "string",
          "format": "uri"
        },
        "servicesUsing": {
          "type": "integer",
          "minimum": 0
        },
        "registeredAt": {
          "type": "string",
          "format": "date-time"
        },
        "lastUsed": {
          "type": "string",
          "format": "date-time"
        },
        "metadata": {
          "type": "object"
        }
      }
    },

    "ServiceMetadataSubmission": {
      "type": "object",
      "description": "Plugin submission payload to collector API",
      "required": ["service"],
      "properties": {
        "service": {
          "$ref": "#/definitions/Service"
        },
        "routes": {
          "type": "array",
          "items": { "$ref": "#/definitions/Route" }
        },
        "dependencies": {
          "type": "array",
          "items": { "$ref": "#/definitions/Dependency" }
        }
      }
    }
  }
}
