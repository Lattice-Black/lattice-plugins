{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Application } from 'express';\nimport {\n  Service,\n  ServiceMetadataSubmission,\n  ServiceStatus,\n  generateId,\n  SDKState,\n} from '@lattice.black/core';\nimport {\n  LatticeConfig,\n  ResolvedLatticeConfig,\n  resolveConfig,\n  SubmissionResponse,\n} from './config/types';\nimport { RouteAnalyzer } from './discovery/route-analyzer';\nimport { DependencyAnalyzer } from './discovery/dependency-analyzer';\nimport { ServiceNameDetector } from './discovery/service-name-detector';\nimport { ApiClient } from './client/api-client';\nimport { NoOpClient, type LatticeApiClient } from './client/noop-client';\nimport { MetricsTracker } from './middleware/metrics-tracker';\nimport { HttpInterceptor } from './client/http-interceptor';\nimport { ErrorCapture, createErrorCapture } from './middleware/error-capture';\nimport { safeAsync } from './utils/safe-wrapper';\n\n/**\n * Lattice Plugin for Express.js\n *\n * Discovers routes, dependencies, and submits metadata to Lattice collector.\n *\n * Features:\n * - Privacy-first data capture (no PII by default)\n * - Configurable sampling to reduce data volume\n * - Event batching for performance\n * - beforeSend hooks for filtering/modifying events\n * - Graceful shutdown with forceFlush\n * - No-op fallback on initialization failure\n *\n * Following patterns from OpenTelemetry, Sentry, and Segment.\n */\nexport class LatticePlugin {\n  private config: ResolvedLatticeConfig;\n  private routeAnalyzer: RouteAnalyzer;\n  private dependencyAnalyzer: DependencyAnalyzer;\n  private serviceNameDetector: ServiceNameDetector;\n  private apiClient: LatticeApiClient;\n  private metadata: ServiceMetadataSubmission | null = null;\n  private submitTimer: NodeJS.Timeout | null = null;\n  private metricsTracker: MetricsTracker | null = null;\n  private httpInterceptor: HttpInterceptor | null = null;\n  private errorCapture: ErrorCapture | null = null;\n  private state: SDKState = SDKState.Uninitialized;\n  private initError: Error | null = null;\n\n  constructor(config: LatticeConfig = {}) {\n    try {\n      this.state = SDKState.Initializing;\n\n      // Resolve config with defaults\n      this.config = resolveConfig(config);\n\n      // Initialize analyzers\n      this.routeAnalyzer = new RouteAnalyzer();\n      this.dependencyAnalyzer = new DependencyAnalyzer();\n      this.serviceNameDetector = new ServiceNameDetector();\n\n      // Initialize API client (or no-op if disabled)\n      if (this.config.enabled) {\n        this.apiClient = new ApiClient(this.config.apiEndpoint, this.config.apiKey);\n      } else {\n        this.apiClient = new NoOpClient();\n      }\n\n      this.state = SDKState.Ready;\n      this.log('debug', 'Plugin initialized successfully');\n    } catch (error) {\n      // Fail gracefully - use no-op client\n      this.state = SDKState.Failed;\n      this.initError = error as Error;\n      this.apiClient = new NoOpClient();\n      this.routeAnalyzer = new RouteAnalyzer();\n      this.dependencyAnalyzer = new DependencyAnalyzer();\n      this.serviceNameDetector = new ServiceNameDetector();\n      this.config = resolveConfig({});\n\n      this.log('error', `Initialization failed: ${(error as Error).message}`);\n    }\n  }\n\n  /**\n   * Analyze Express application and discover metadata\n   */\n  async analyze(app: Application): Promise<ServiceMetadataSubmission> {\n    if (!this.config.enabled || this.state === SDKState.Failed) {\n      this.log('debug', 'Plugin is disabled or failed, returning empty metadata');\n      return this.getEmptyMetadata();\n    }\n\n    const result = await safeAsync(\n      async () => {\n        // Detect service name\n        const serviceName = this.serviceNameDetector.detectServiceName(this.config.serviceName);\n\n        // Store detected service name in config for use by other components\n        this.config.serviceName = serviceName;\n\n        // Get package.json for version\n        const pkgJson = this.getPackageJson();\n\n        // Create service entity\n        const serviceId = generateId();\n        const service: Service = {\n          id: serviceId,\n          name: serviceName,\n          version: pkgJson?.version,\n          environment: this.config.environment as 'development' | 'staging' | 'production',\n          language: 'typescript',\n          framework: 'express',\n          runtime: `node-${process.version}`,\n          status: ServiceStatus.Active,\n          firstSeen: new Date(),\n          lastSeen: new Date(),\n          discoveredBy: {\n            pluginName: '@lattice/plugin-express',\n            pluginVersion: '0.2.0',\n            schemaVersion: '1.0.0',\n          },\n        };\n\n        // Discover routes\n        const routes = this.config.discoverRoutes\n          ? this.routeAnalyzer.analyzeRoutes(app, serviceId)\n          : [];\n\n        // Discover dependencies\n        const dependencies = this.config.discoverDependencies\n          ? this.dependencyAnalyzer.analyzeDependencies(serviceId, this.config.packageJsonPath)\n          : [];\n\n        // Create metadata submission\n        this.metadata = {\n          service,\n          routes,\n          dependencies,\n        };\n\n        // Call onAnalyzed callback\n        if (this.config.onAnalyzed) {\n          this.config.onAnalyzed(this.metadata);\n        }\n\n        this.log(\n          'info',\n          `Discovered service \"${serviceName}\" with ${routes.length} routes and ${dependencies.length} dependencies`\n        );\n\n        // Auto-submit if enabled\n        if (this.config.autoSubmit) {\n          await this.submit();\n        }\n\n        // Start auto-submit interval\n        this.start();\n\n        return this.metadata;\n      },\n      this.getEmptyMetadata(),\n      'LatticePlugin.analyze'\n    );\n\n    return result;\n  }\n\n  /**\n   * Submit metadata to Lattice collector API\n   */\n  async submit(metadata?: ServiceMetadataSubmission): Promise<SubmissionResponse | null> {\n    if (!this.config.enabled) {\n      return null;\n    }\n\n    const dataToSubmit = metadata || this.metadata;\n\n    if (!dataToSubmit) {\n      this.log('warn', 'No metadata to submit. Call analyze() first.');\n      return null;\n    }\n\n    const result = await safeAsync(\n      async () => {\n        const response = await this.apiClient.submitMetadata(dataToSubmit);\n\n        // Call onSubmitted callback\n        if (this.config.onSubmitted) {\n          this.config.onSubmitted(response);\n        }\n\n        this.log('debug', `Metadata submitted: ${response.serviceId}`);\n\n        return response;\n      },\n      null,\n      'LatticePlugin.submit'\n    );\n\n    return result;\n  }\n\n  /**\n   * Get current metadata\n   */\n  getMetadata(): ServiceMetadataSubmission | null {\n    return this.metadata;\n  }\n\n  /**\n   * Get service name\n   */\n  getServiceName(): string {\n    return this.metadata?.service.name || this.config.serviceName || 'unknown';\n  }\n\n  /**\n   * Check if plugin is enabled\n   */\n  isEnabled(): boolean {\n    return this.config.enabled;\n  }\n\n  /**\n   * Get SDK state\n   */\n  getState(): SDKState {\n    return this.state;\n  }\n\n  /**\n   * Get initialization error if any\n   */\n  getInitError(): Error | null {\n    return this.initError;\n  }\n\n  /**\n   * Start auto-submit interval\n   */\n  start(): void {\n    if (!this.config.enabled || !this.config.autoSubmit || this.submitTimer) {\n      return;\n    }\n\n    this.submitTimer = setInterval(() => {\n      if (this.metadata) {\n        // Update lastSeen timestamp\n        this.metadata.service.lastSeen = new Date();\n        this.submit().catch(() => {\n          // Error already logged by safeAsync\n        });\n      }\n    }, this.config.submitInterval);\n\n    // Ensure timer doesn't prevent process from exiting\n    this.submitTimer.unref();\n  }\n\n  /**\n   * Stop auto-submit interval\n   */\n  stop(): void {\n    if (this.submitTimer) {\n      clearInterval(this.submitTimer);\n      this.submitTimer = null;\n    }\n  }\n\n  /**\n   * Force flush all pending events\n   * Call this before shutdown to ensure all data is sent\n   */\n  async forceFlush(timeoutMs?: number): Promise<void> {\n    this.log('debug', 'Force flushing all pending events');\n\n    const promises: Promise<void>[] = [];\n\n    if (this.errorCapture) {\n      promises.push(this.errorCapture.forceFlush());\n    }\n\n    if (this.metricsTracker) {\n      promises.push(this.metricsTracker.forceFlush());\n    }\n\n    // Wait for all flushes with timeout\n    if (timeoutMs) {\n      await Promise.race([\n        Promise.allSettled(promises),\n        new Promise((resolve) => setTimeout(resolve, timeoutMs)),\n      ]);\n    } else {\n      await Promise.allSettled(promises);\n    }\n  }\n\n  /**\n   * Graceful shutdown\n   * Stops accepting new events, flushes pending data, and cleans up resources\n   */\n  async shutdown(timeoutMs: number = 10000): Promise<void> {\n    if (this.state === SDKState.ShuttingDown || this.state === SDKState.Shutdown) {\n      return;\n    }\n\n    this.state = SDKState.ShuttingDown;\n    this.log('debug', 'Shutting down...');\n\n    // Stop accepting new events\n    this.stop();\n\n    // Flush pending data\n    await this.forceFlush(timeoutMs);\n\n    // Clean up resources\n    if (this.errorCapture) {\n      this.errorCapture.shutdown();\n    }\n\n    if (this.metricsTracker) {\n      this.metricsTracker.shutdown();\n    }\n\n    this.state = SDKState.Shutdown;\n    this.log('debug', 'Shutdown complete');\n  }\n\n  /**\n   * Create metrics tracking middleware\n   * Can be called before or after analyze() - uses configured service name\n   */\n  createMetricsMiddleware() {\n    if (!this.metricsTracker) {\n      // Use configured service name, or detected name if available\n      const serviceName = this.serviceNameDetector.detectServiceName(this.config.serviceName);\n      this.metricsTracker = new MetricsTracker(\n        serviceName,\n        this.config.apiEndpoint,\n        this.config.apiKey,\n        {\n          enabled: this.config.enabled,\n          debug: this.config.debug,\n          sampling: this.config.sampling,\n          batching: this.config.batching,\n        }\n      );\n    }\n    return this.metricsTracker.middleware();\n  }\n\n  /**\n   * Get HTTP interceptor for outgoing requests\n   * Automatically injects X-Origin-Service header for distributed tracing\n   *\n   * Usage:\n   * ```typescript\n   * const http = lattice.getHttpClient();\n   *\n   * // Use wrapped fetch\n   * const response = await http.fetch('http://other-service/api/users');\n   *\n   * // Or get headers for axios/other clients\n   * const headers = http.getTracingHeaders();\n   * axios.get('http://other-service/api/users', { headers });\n   * ```\n   */\n  getHttpClient(): HttpInterceptor {\n    if (!this.httpInterceptor) {\n      const serviceName = this.serviceNameDetector.detectServiceName(this.config.serviceName);\n      this.httpInterceptor = new HttpInterceptor(serviceName);\n    }\n    return this.httpInterceptor;\n  }\n\n  /**\n   * Create error capture middleware\n   * MUST be registered AFTER all routes as an error handler\n   *\n   * Usage:\n   * ```typescript\n   * app.use(lattice.errorHandler());\n   * ```\n   */\n  errorHandler() {\n    if (!this.errorCapture) {\n      const serviceName = this.serviceNameDetector.detectServiceName(this.config.serviceName);\n\n      // Create error capture with full config\n      this.errorCapture = createErrorCapture({\n        ...this.config,\n        serviceName,\n      });\n    }\n    return this.errorCapture.middleware();\n  }\n\n  /**\n   * Manually capture an error\n   */\n  async captureError(error: Error, context?: Record<string, unknown>): Promise<void> {\n    if (!this.errorCapture) {\n      // Create error capture on first use\n      const serviceName = this.serviceNameDetector.detectServiceName(this.config.serviceName);\n      this.errorCapture = createErrorCapture({\n        ...this.config,\n        serviceName,\n      });\n    }\n\n    await this.errorCapture.captureError(error, context);\n  }\n\n  /**\n   * Get the resolved configuration\n   */\n  getConfig(): Readonly<ResolvedLatticeConfig> {\n    return this.config;\n  }\n\n  // Private methods\n\n  /**\n   * Conditional logging\n   */\n  private log(level: 'debug' | 'info' | 'warn' | 'error', message: string): void {\n    const prefix = '[Lattice]';\n\n    if (level === 'error') {\n      console.error(`${prefix} ${message}`);\n      if (this.config.onError) {\n        this.config.onError(new Error(message));\n      }\n    } else if (level === 'warn') {\n      console.warn(`${prefix} ${message}`);\n    } else if (level === 'info') {\n      console.log(`${prefix} âœ… ${message}`);\n    } else if (this.config.debug) {\n      console.log(`${prefix} ${message}`);\n    }\n  }\n\n  /**\n   * Get package.json content\n   */\n  private getPackageJson(): { version?: string; name?: string } | null {\n    try {\n      const fs = require('fs');\n      const path = require('path');\n      const pkgPath = path.join(process.cwd(), 'package.json');\n\n      if (fs.existsSync(pkgPath)) {\n        return JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));\n      }\n    } catch {\n      // Ignore\n    }\n    return null;\n  }\n\n  /**\n   * Get empty metadata structure\n   */\n  private getEmptyMetadata(): ServiceMetadataSubmission {\n    return {\n      service: {\n        id: generateId(),\n        name: 'disabled',\n        language: 'typescript',\n        framework: 'express',\n        status: ServiceStatus.Unknown,\n        firstSeen: new Date(),\n        lastSeen: new Date(),\n        discoveredBy: {\n          pluginName: '@lattice/plugin-express',\n          pluginVersion: '0.2.0',\n          schemaVersion: '1.0.0',\n        },\n      },\n      routes: [],\n      dependencies: [],\n    };\n  }\n}\n\n// Re-export types and utilities for convenience\nexport * from './config/types';\nexport { HttpInterceptor } from './client/http-interceptor';\nexport { ErrorCapture } from './middleware/error-capture';\nexport { NoOpClient, type LatticeApiClient } from './client/noop-client';\nexport { EventQueue, createEventQueue } from './utils/event-queue';\nexport { Sampler, createSampler } from './utils/sampler';\nexport { DataScrubber, createDataScrubber } from './utils/data-scrubber';\nexport {\n  safeAsync,\n  safeSync,\n  createSafeAsyncWrapper,\n  createSafeSyncWrapper,\n} from './utils/safe-wrapper';\n\n// Convenience alias\nexport { LatticePlugin as LatticeExpress } from './index';\n"]}