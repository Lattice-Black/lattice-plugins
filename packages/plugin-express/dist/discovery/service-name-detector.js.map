{"version":3,"file":"service-name-detector.js","sourceRoot":"","sources":["../../src/discovery/service-name-detector.ts"],"names":[],"mappings":"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","sourcesContent":["import { readFileSync, existsSync } from 'fs';\nimport { join, basename } from 'path';\nimport { hostname } from 'os';\n\n/**\n * Service name detector with 9-tier fallback chain\n * Based on research.md recommendations\n */\nexport class ServiceNameDetector {\n  /**\n   * Detect service name using fallback chain\n   */\n  detectServiceName(customName?: string): string {\n    // Tier 1: Custom name provided via config\n    if (customName) {\n      return this.sanitizeName(customName);\n    }\n\n    // Tier 2: LATTICE_SERVICE_NAME environment variable\n    if (process.env['LATTICE_SERVICE_NAME']) {\n      return this.sanitizeName(process.env['LATTICE_SERVICE_NAME']);\n    }\n\n    // Tier 3: SERVICE_NAME environment variable\n    if (process.env['SERVICE_NAME']) {\n      return this.sanitizeName(process.env['SERVICE_NAME']);\n    }\n\n    // Tier 4: package.json name field\n    const pkgName = this.getPackageJsonName();\n    if (pkgName) {\n      return this.sanitizeName(pkgName);\n    }\n\n    // Tier 5: Kubernetes metadata\n    const k8sName = this.getKubernetesServiceName();\n    if (k8sName) {\n      return this.sanitizeName(k8sName);\n    }\n\n    // Tier 6: Docker container name\n    const dockerName = this.getDockerContainerName();\n    if (dockerName) {\n      return this.sanitizeName(dockerName);\n    }\n\n    // Tier 7: Cloud provider metadata (AWS, GCP, Azure)\n    const cloudName = this.getCloudServiceName();\n    if (cloudName) {\n      return this.sanitizeName(cloudName);\n    }\n\n    // Tier 8: Git repository name\n    const gitName = this.getGitRepoName();\n    if (gitName) {\n      return this.sanitizeName(gitName);\n    }\n\n    // Tier 9: Hostname or current directory name\n    const fallbackName = this.getFallbackName();\n    return this.sanitizeName(fallbackName);\n  }\n\n  /**\n   * Tier 4: Get name from package.json\n   */\n  private getPackageJsonName(): string | null {\n    try {\n      let currentDir = process.cwd();\n\n      for (let i = 0; i < 5; i++) {\n        const pkgPath = join(currentDir, 'package.json');\n\n        if (existsSync(pkgPath)) {\n          const content = readFileSync(pkgPath, 'utf-8');\n          const pkg = JSON.parse(content) as { name?: string };\n\n          if (pkg.name) {\n            // Remove npm scope if present\n            return pkg.name.replace(/^@[\\w-]+\\//, '');\n          }\n        }\n\n        const parentDir = join(currentDir, '..');\n        if (parentDir === currentDir) break;\n        currentDir = parentDir;\n      }\n    } catch (error) {\n      // Ignore errors\n    }\n\n    return null;\n  }\n\n  /**\n   * Tier 5: Get Kubernetes service name from environment\n   */\n  private getKubernetesServiceName(): string | null {\n    // Kubernetes sets these environment variables\n    return (\n      process.env['K8S_SERVICE_NAME'] ||\n      process.env['KUBERNETES_SERVICE_NAME'] ||\n      process.env['K8S_POD_NAME'] ||\n      null\n    );\n  }\n\n  /**\n   * Tier 6: Get Docker container name from hostname\n   */\n  private getDockerContainerName(): string | null {\n    // Docker containers often have hostname set to container ID/name\n    if (process.env['DOCKER_CONTAINER_NAME']) {\n      return process.env['DOCKER_CONTAINER_NAME'];\n    }\n\n    // Check if running in Docker by looking for .dockerenv\n    if (existsSync('/.dockerenv')) {\n      return hostname();\n    }\n\n    return null;\n  }\n\n  /**\n   * Tier 7: Get cloud service name from metadata\n   */\n  private getCloudServiceName(): string | null {\n    // AWS ECS\n    if (process.env['AWS_ECS_SERVICE_NAME']) {\n      return process.env['AWS_ECS_SERVICE_NAME'];\n    }\n\n    // Google Cloud Run\n    if (process.env['K_SERVICE']) {\n      return process.env['K_SERVICE'];\n    }\n\n    // Azure Container Apps\n    if (process.env['CONTAINER_APP_NAME']) {\n      return process.env['CONTAINER_APP_NAME'];\n    }\n\n    return null;\n  }\n\n  /**\n   * Tier 8: Get Git repository name\n   */\n  private getGitRepoName(): string | null {\n    try {\n      // Try to read .git/config\n      const gitConfigPath = join(process.cwd(), '.git', 'config');\n\n      if (existsSync(gitConfigPath)) {\n        const config = readFileSync(gitConfigPath, 'utf-8');\n        const urlMatch = config.match(/url\\s*=\\s*.*\\/([^/]+?)(?:\\.git)?$/m);\n\n        if (urlMatch?.[1]) {\n          return urlMatch[1];\n        }\n      }\n    } catch (error) {\n      // Ignore errors\n    }\n\n    return null;\n  }\n\n  /**\n   * Tier 9: Fallback to hostname or directory name\n   */\n  private getFallbackName(): string {\n    // Try current directory name\n    const dirName = basename(process.cwd());\n\n    if (dirName && dirName !== '/' && dirName !== '.') {\n      return dirName;\n    }\n\n    // Last resort: hostname\n    return hostname() || 'unknown-service';\n  }\n\n  /**\n   * Sanitize service name to DNS-compatible format\n   * Rules: lowercase, alphanumeric + hyphens, 2-63 chars\n   */\n  private sanitizeName(name: string): string {\n    // Convert to lowercase\n    let sanitized = name.toLowerCase();\n\n    // Replace invalid characters with hyphens\n    sanitized = sanitized.replace(/[^a-z0-9-]/g, '-');\n\n    // Remove leading/trailing hyphens\n    sanitized = sanitized.replace(/^-+|-+$/g, '');\n\n    // Collapse multiple hyphens\n    sanitized = sanitized.replace(/-+/g, '-');\n\n    // Ensure length constraints\n    if (sanitized.length < 2) {\n      sanitized = 'svc-' + sanitized;\n    }\n\n    if (sanitized.length > 63) {\n      sanitized = sanitized.substring(0, 63);\n    }\n\n    // Remove trailing hyphen after truncation\n    sanitized = sanitized.replace(/-+$/, '');\n\n    return sanitized || 'unknown-service';\n  }\n}\n"]}